name: Keep Streamlit App Awake

on:
  schedule:
    # Run every 6 hours to prevent Community Cloud hibernation due to inactivity
    - cron: "0 */6 * * *"
  # Allow manual runs from the GitHub Actions UI
  workflow_dispatch:

jobs:
  wake-up:
    runs-on: ubuntu-latest
    steps:
      # Set up Python for the runner
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Install Selenium (Selenium Manager will handle driver discovery in many cases)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium

      # Use a real headless browser to generate "real" traffic and click the wake button if present
      - name: Wake Streamlit app via Selenium
        shell: bash
        run: |
          python - <<'PY'
          import time
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By
          from selenium.webdriver.support.ui import WebDriverWait
          from selenium.webdriver.support import expected_conditions as EC
          from selenium.common.exceptions import TimeoutException

          APP_URL = "https://esemcelldesign.streamlit.app"

          options = Options()
          options.add_argument("--headless=new")
          options.add_argument("--no-sandbox")
          options.add_argument("--disable-dev-shm-usage")
          options.add_argument("--disable-gpu")

          print(f"Opening the app URL: {APP_URL}")
          driver = webdriver.Chrome(options=options)

          try:
            driver.get(APP_URL)

            # Give Streamlit time to initialize and establish a session
            time.sleep(10)

            # If the app is asleep, the page shows a wake-up button; click it when found
            button_xpath = "//button[contains(., 'Yes, get this app back up')]"
            try:
              button = WebDriverWait(driver, 6).until(
                EC.element_to_be_clickable((By.XPATH, button_xpath))
              )
              print("Sleep screen detected. Clicking the wake-up button...")
              button.click()
              time.sleep(6)
              print("Wake-up click sent successfully.")
            except TimeoutException:
              print("No sleep button found. The app seems already awake.")

          finally:
            driver.quit()
          PY
